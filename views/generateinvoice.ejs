<% include partials/header.ejs %>
<% include partials/menu %>

	<div class="divider"></div>

	<div class="container">
		<div class="centertext">
			<h1>Generate an <span class="greentext">Invoice</span></h1>
			<h5>You can create invoices for customers on this page.</h5>
		</div>
		<div class="divider"></div>
		<div class="row">
			<div class="col-md-6">
				<div class="card">
					<div class="card-body">
						<p>Select and add products to the invoice list from your available stock and click on generate invoice to make a customer invoice. </p>

						<hr>

						<div class="form-group">
						    <label for="exampleFormControlSelect1">Select Product</label>
						    <select id="itemname" class="form-control" id="exampleFormControlSelect1" required="">

						      <% shop.shopinventory.forEach(function(invento) { %>
						      		<option value="<%= invento.itemname %>"><%= invento.itemname %> @ ksh <%= invento.itemsprice %></option>
						      <% }) %>
						    </select>
						  </div>

						  <div class="form-group">
						    <label for="exampleFormControlSelect1">Selling Price at (KSH): </label>
						    <input type="number" class="form-control" id="itemsprice" placeholder="Number of items" required>
						  </div>

						  <div class="form-group">
						    <label for="exampleFormControlSelect1">Quantity</label>
						    <input type="number" class="form-control" id="quantity" placeholder="Number of items" required name="itemquantity">
						  </div>

						  <button type="button" onclick="addItem();" class="btn btn-info btn-sm greenbtn">Add to Invoice</button>
					</div>
				</div>
			</div>
			<div class="col-md-6">
				<div class="topsec">
					<div class="row">
						<div class="col-lg-12">
							<p class="topsec_title">Invoice List</p>
						</div>
					</div>
				</div>
				<div class="card">
					<div class="card-body" id="item">
						<div class="align-right greentext">Total(Ksh): <span id="invoiceView"></span></div>
						<hr>
					</div>
				</div>
				<div class="smdivider"></div>

				<div class="topsec">
					<div class="row">
						<div class="col-lg-12">
							<p class="topsec_title">Customer Details</p>
						</div>
					</div>
				</div>
				<div class="card">
					<div class="card-body" id="item">
						<div class="form-group">
						    <label for="customername">Customer Name</label>
						    <input type="text" class="form-control" id="customername" aria-describedby="emailHelp" placeholder="Enter customer name">
						</div>
						<div class="form-group">
						    <label for="customeremail">Customer Email address</label>
						    <input type="email" class="form-control" id="customeremail" aria-describedby="emailHelp" placeholder="Enter customer email">
						</div>
						<div class="form-group">
						    <label for="customerphone">Customer Phone Number</label>
						    <input type="text" class="form-control" id="customerphone" aria-describedby="emailHelp" placeholder="Enter customer phone">
						</div>
						<div class="form-group">
						    <label for="duedate">Due Date</label>
						    <input type="text" class="form-control" id="duedate" aria-describedby="emailHelp" placeholder="Enter due date">
						</div>
					</div>
				</div>
				<div class="smdivider"></div>

				<button type="button" class="btn btn-info btn-sm greenbtn" onclick="generateInvoice();" >Generate Invoice</button>
				<button type="button" class="btn btn-light btn-sm">View Invoice</button>
			</div>		
		</div>

		<div class="divider"></div>
		<div class="divider"></div>

		<hr>

		<!-- All code from the actual invoice Document -->
		<div id="invoice">
			<div class="row">
				<div class="col-md-6">
					<h3 class="invoiceHeader">INVOICE</h3>
					<div class="smalltext">
						<div><strong>Bill to</strong>: <span id="thecustomer"></span></div>
						<div><strong>Phone Number</strong>: <span id="thephone"></span></div>
						<div><strong>Email</strong>: <span id="themail"></span></div>
						<div><strong>Payment Terms</strong>: Due on receipt</div>
						<div><strong>Due date</strong>: <span id="theduedate"></span></div>
					</div>		

					<div class="divider"></div>
				</div>

				<div class="col-md-6 align-right">
					<h4 class="invoiceHeader">Simple <span class="greentext">Shop</span></h4>
					<div class="smalltext">
						<div><em>From: <%= shop.shopname %></em></div>
						<div><em>Generated by: <%= currentUser.firstname %> <%= currentUser.lastname %></em></div>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-md-12">
					<div>

						<div class="card noborderad">
							<div class="card-body invoicetop">
								<div class="row">
									<div class="col-md-4"><strong>Item</strong></div>
									<div class="col-md-4"><strong>Quantity</strong></div>
									<div class="col-md-4"><strong>Total</strong></div>
								</div>
							</div>
						</div>
						
						<div class="card">
							<div class="card-body" id="generateinvoicelist"></div>
						</div>

						<div class="divider"></div>

						<h5>Total Amount Due: <span class="greentext">KSH <span id="generatedTotal"></span></span></h5>
						
						
					</div>
				</div>		
			</div>
		</div>
	</div>

	<script>
		
		var invoiceTotal = 0;
		var itemname = document.getElementById("itemname");
		var itemsprice = document.getElementById("itemsprice");
		var quantity = document.getElementById("quantity");
		var item = document.getElementById("item");
		var invoiceView = document.getElementById("invoiceView");
		var generateinvoicelist = document.getElementById("generateinvoicelist");
		var generateTotal = document.getElementById("generatedTotal");

		function addItem() {

			var genRow = document.createElement("div");
			genRow.classList.add("row")
			var genItem = document.createElement("div");
			var genQuantity = document.createElement("div");
			var genTotal = document.createElement("div");
			genItem.setAttribute("class", "col-md-4");
			genQuantity.setAttribute("class", "col-md-4");
			genTotal.setAttribute("class", "col-md-4");
			genItem.textContent = itemname.value;
			genQuantity.textContent = quantity.value;
			genTotal.textContent = quantity.value * itemsprice.value;
			genRow.appendChild(genItem);
			genRow.appendChild(genQuantity);
			genRow.appendChild(genTotal);
			generateinvoicelist.appendChild(genRow);

			var row = document.createElement("div");
			row.setAttribute("class", "row smalltext");
			var firstCol = document.createElement("div");
			firstCol.classList.add("col-md-6");
			var secondCol = document.createElement("div");
			secondCol.setAttribute("class", "col-md-6 align-right");
			item.appendChild(row);
			row.appendChild(firstCol);
			row.appendChild(secondCol);

			firstCol.textContent = itemname.value + " (" + quantity.value + ")";
			secondCol.textContent = quantity.value * itemsprice.value;

			invoiceTotal += quantity.value * itemsprice.value;
			invoiceView.textContent = invoiceTotal.toLocaleString();
			generatedTotal.textContent = invoiceTotal.toLocaleString();
		}

		function generateInvoice() {
			var thecustomer = document.getElementById("thecustomer");
			var thephone = document.getElementById("thephone");
			var themail = document.getElementById("themail");
			var theduedate = document.getElementById("theduedate");

			var customername = document.getElementById("customername");
			var customerphone = document.getElementById("customerphone");
			var customeremail = document.getElementById("customeremail");
			var duedate = document.getElementById("duedate");

			thecustomer.textContent = customername.value;
			thephone.textContent = customerphone.value;
			themail.textContent = customeremail.value;
			theduedate.textContent = duedate.value;
			// Default export is a4 paper, portrait, using milimeters for units
			html2canvas(document.getElementById("invoice"), {
				onrendered: function(canvas) {
					var imgData = canvas.toDataURL(
                    'image/png');              
	                var doc = new jsPDF('p', 'mm');
	                doc.addImage(imgData, 'PNG', 15, 15);
	                doc.save('invoice.pdf');
				}
			});	
		}

	</script>

<% include partials/footer.ejs %>









